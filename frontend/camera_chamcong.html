<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Ch·∫•m c√¥ng b·∫±ng khu√¥n m·∫∑t</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    h2 {
      font-weight: 600;
      color: #343a40;
    }

    video {
      width: 100%;
      max-width: 500px;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border: 2px solid #dee2e6;
      background-color: #fff;
    }

    #countdown {
      font-size: 2.5rem;
      color: #00378a;
      font-weight: bold;
      margin-top: 12px;
    }

    .btn-group button {
      min-width: 130px;
      font-weight: 500;
      font-size: 1rem;
      transition: 0.2s ease;
    }

    .btn-group button:hover {
      transform: scale(1.03);
    }

    .alert {
      max-width: 500px;
    }
  </style>
</head>

<body class="container py-5 text-center">
  <h2 class="mb-4">Ch·∫•m c√¥ng b·∫±ng FaceID</h2>

  <div class="d-flex flex-column align-items-center">
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="countdown"></div>
    <h5 class="text-muted mt-2">üí° Gi·ªØ khu√¥n m·∫∑t r√µ n√©t, √°nh s√°ng ƒë·ªß v√† nh√¨n th·∫≥ng v√†o camera</h5>

    <div class="btn-group mt-3 gap-2">
      <button type="button" class="btn btn-success" onclick="takePicture()">Ch·∫•m c√¥ng</button>
    </div>

    <!-- Alert hi·ªÉn th·ªã k·∫øt qu·∫£ (v·∫´n gi·ªØ n·∫øu c·∫ßn d√πng cho m·ª•c ƒë√≠ch kh√°c) -->
    <div id="alertBox" class="alert d-none mt-4" role="alert"></div>
  </div>

  <!-- Modal k·∫øt qu·∫£ -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resultModalLabel">Th√¥ng b√°o</h5>
        </div>
        <div class="modal-body" id="modalMessage">
          <!-- N·ªôi dung th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c ch√®n b·∫±ng JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="okButton">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const countdownEl = document.getElementById("countdown");
    const alertBox = document.getElementById("alertBox");

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => showToast("‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera", "danger"));

    function takePicture() {
      console.log("B·∫Øt ƒë·∫ßu takePicture");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const gray = [];
      for (let i = 0; i < imageData.data.length; i += 4) {
        gray.push(0.299 * imageData.data[i] + 0.587 * imageData.data[i + 1] + 0.114 * imageData.data[i + 2]);
      }

      let laplacian = [];
      const w = canvas.width;
      const h = canvas.height;
      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const idx = y * w + x;
          const lap = -gray[idx - w] - gray[idx - 1] + 4 * gray[idx] - gray[idx + 1] - gray[idx + w];
          laplacian.push(lap);
        }
      }

      const mean = laplacian.reduce((a, b) => a + b, 0) / laplacian.length;
      const variance = laplacian.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / laplacian.length;

      if (variance < 20) {
        showToast("‚ö†Ô∏è ·∫¢nh qu√° m·ªù! Vui l√≤ng th·ª≠ l·∫°i.", "warning");
        return;
      }

      const dataURL = canvas.toDataURL("image/jpeg");
      submitImage(dataURL);
    }

    async function submitImage(base64Image) {
      try {
        const response = await fetch("http://127.0.0.1:5000/api/face-checkin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image_base64: base64Image })

        });

        const text = await response.text();
        console.log("Ph·∫£n h·ªìi raw:", text);
        let result;

        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error("L·ªói parse JSON:", e);
          showToast("‚ùå Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.", "danger");
          return;
        }

        console.log("Ph·∫£n h·ªìi parse:", result);

        if (response.ok) {
          const now = new Date();
          const timeString = now.toLocaleString("vi-VN", {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          });

          showToast(`‚úÖ ${result.message}<br><small>Th·ªùi gian: ${timeString}</small>`, "success");
        } else {
          showToast(`‚ùå ${result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, "danger");
        }

      } catch (error) {
        console.error("L·ªói k·∫øt n·ªëi:", error);
        showToast("‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn server.", "danger");
      }

    }

    function showToast(message, type) {
      const modalMessage = document.getElementById("modalMessage");
      const resultModal = new bootstrap.Modal(document.getElementById("resultModal"));
      const okButton = document.getElementById("okButton");

      // G√°n m√†u d·ª±a tr√™n ki·ªÉu alert
      let alertClass = "text-dark";
      if (type === "success") alertClass = "text-success";
      else if (type === "danger") alertClass = "text-danger";
      else if (type === "warning") alertClass = "text-warning";

      modalMessage.innerHTML = `<div class="${alertClass}">${message}</div>`;
      resultModal.show();

      okButton.onclick = () => {
        resultModal.hide();
        if (type === "success") {
          location.reload();  // Ch·ªâ reload n·∫øu l√† th√†nh c√¥ng
        }
      };
    }

    document.querySelector("form")?.addEventListener("submit", function (e) {
      e.preventDefault();
    });
  </script>
</body>

</html>
